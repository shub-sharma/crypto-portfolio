import { NextResponse } from "next/server";

export async function POST(req: Request) {
  try {
    const tickersList = await req.json();
    if (!tickersList || !Array.isArray(tickersList)) {
      return new NextResponse("Tickers list is required and must be an array", {
        status: 400,
      });
    }

    //TODO: Remove
    // const jsonData = [
    //   {
    //     id: "bitcoin",
    //     symbol: "btc",
    //     name: "Bitcoin",
    //     image:
    //       "https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1696501400",
    //     current_price: 67641.28,
    //     market_cap: 1332710987306,
    //     market_cap_rank: 1,
    //     fully_diluted_valuation: 1420461267270,
    //     total_volume: 32432239000,
    //     high_24h: 70029,
    //     low_24h: 66725,
    //     price_change_24h: -1807.697824486997,
    //     price_change_percentage_24h: -2.60291,
    //     market_cap_change_24h: -36609436331.32202,
    //     market_cap_change_percentage_24h: -2.67355,
    //     circulating_supply: 19702706,
    //     total_supply: 21000000,
    //     max_supply: 21000000,
    //     ath: 73738,
    //     ath_change_percentage: -8.24972,
    //     ath_date: "2024-03-14T07:10:36.635Z",
    //     atl: 67.81,
    //     atl_change_percentage: 99672.54527,
    //     atl_date: "2013-07-06T00:00:00.000Z",
    //     roi: null,
    //     last_updated: "2024-05-24T04:45:28.367Z",
    //     price_change_percentage_1h_in_currency: -0.36632798684830187,
    //     price_change_percentage_1y_in_currency: 152.74067472583747,
    //     price_change_percentage_24h_in_currency: -2.602914764955562,
    //     price_change_percentage_30d_in_currency: 1.5626650849789117,
    //     price_change_percentage_7d_in_currency: 3.018868584906087,
    //   },
    //   {
    //     id: "ethereum",
    //     symbol: "eth",
    //     name: "Ethereum",
    //     image:
    //       "https://assets.coingecko.com/coins/images/279/large/ethereum.png?1696501628",
    //     current_price: 3808,
    //     market_cap: 457377904121,
    //     market_cap_rank: 2,
    //     fully_diluted_valuation: 457377904121,
    //     total_volume: 47276206002,
    //     high_24h: 3937.9,
    //     low_24h: 3675.43,
    //     price_change_24h: 23.18,
    //     price_change_percentage_24h: 0.61252,
    //     market_cap_change_24h: 2876751339,
    //     market_cap_change_percentage_24h: 0.63295,
    //     circulating_supply: 120131150.736985,
    //     total_supply: 120131150.736985,
    //     max_supply: null,
    //     ath: 4878.26,
    //     ath_change_percentage: -21.99582,
    //     ath_date: "2021-11-10T14:24:19.604Z",
    //     atl: 0.432979,
    //     atl_change_percentage: 878752.81149,
    //     atl_date: "2015-10-20T00:00:00.000Z",
    //     roi: {
    //       times: 74.27008819110277,
    //       currency: "btc",
    //       percentage: 7427.008819110278,
    //     },
    //     last_updated: "2024-05-24T04:45:41.123Z",
    //     price_change_percentage_1h_in_currency: 0.16369206633030367,
    //     price_change_percentage_1y_in_currency: 109.10533439615149,
    //     price_change_percentage_24h_in_currency: 0.6125164563639737,
    //     price_change_percentage_30d_in_currency: 17.61914556790917,
    //     price_change_percentage_7d_in_currency: 29.10185408732675,
    //   },
    //   {
    //     id: "binancecoin",
    //     symbol: "bnb",
    //     name: "BNB",
    //     image:
    //       "https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png?1696501970",
    //     current_price: 601.47,
    //     market_cap: 92540624152,
    //     market_cap_rank: 4,
    //     fully_diluted_valuation: 92540624152,
    //     total_volume: 1784929400,
    //     high_24h: 616.76,
    //     low_24h: 583.14,
    //     price_change_24h: -13.838093064470513,
    //     price_change_percentage_24h: -2.24899,
    //     market_cap_change_24h: -2033671918.176239,
    //     market_cap_change_percentage_24h: -2.15034,
    //     circulating_supply: 153856150,
    //     total_supply: 153856150,
    //     max_supply: 200000000,
    //     ath: 686.31,
    //     ath_change_percentage: -12.44526,
    //     ath_date: "2021-05-10T07:24:17.097Z",
    //     atl: 0.0398177,
    //     atl_change_percentage: 1509012.82895,
    //     atl_date: "2017-10-19T00:00:00.000Z",
    //     roi: null,
    //     last_updated: "2024-05-24T04:45:51.601Z",
    //     price_change_percentage_1h_in_currency: 0.01942525391155782,
    //     price_change_percentage_1y_in_currency: 94.86635259964187,
    //     price_change_percentage_24h_in_currency: -2.2489865678874588,
    //     price_change_percentage_30d_in_currency: -0.603716063891768,
    //     price_change_percentage_7d_in_currency: 5.197528743635132,
    //   },
    //   {
    //     id: "solana",
    //     symbol: "sol",
    //     name: "Solana",
    //     image:
    //       "https://assets.coingecko.com/coins/images/4128/large/solana.png?1696504756",
    //     current_price: 170.07,
    //     market_cap: 76419262937,
    //     market_cap_rank: 5,
    //     fully_diluted_valuation: 98078098085,
    //     total_volume: 4964919482,
    //     high_24h: 179.16,
    //     low_24h: 167.46,
    //     price_change_24h: -8.027684407364063,
    //     price_change_percentage_24h: -4.50752,
    //     market_cap_change_24h: -3540179880.9726715,
    //     market_cap_change_percentage_24h: -4.42747,
    //     circulating_supply: 449296623.174141,
    //     total_supply: 576636787.41775,
    //     max_supply: null,
    //     ath: 259.96,
    //     ath_change_percentage: -34.54055,
    //     ath_date: "2021-11-06T21:54:35.825Z",
    //     atl: 0.500801,
    //     atl_change_percentage: 33879.13003,
    //     atl_date: "2020-05-11T19:35:23.449Z",
    //     roi: null,
    //     last_updated: "2024-05-24T04:45:24.879Z",
    //     price_change_percentage_1h_in_currency: -1.2492793236774684,
    //     price_change_percentage_1y_in_currency: 770.2106562411808,
    //     price_change_percentage_24h_in_currency: -4.507519168295749,
    //     price_change_percentage_30d_in_currency: 8.490376233387483,
    //     price_change_percentage_7d_in_currency: 4.840438860573076,
    //   },
    //   {
    //     id: "ripple",
    //     symbol: "xrp",
    //     name: "XRP",
    //     image:
    //       "https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png?1696501442",
    //     current_price: 0.53,
    //     market_cap: 29380727524,
    //     market_cap_rank: 8,
    //     fully_diluted_valuation: 52998070148,
    //     total_volume: 1710563472,
    //     high_24h: 0.535795,
    //     low_24h: 0.510786,
    //     price_change_24h: 0.00171906,
    //     price_change_percentage_24h: 0.32533,
    //     market_cap_change_24h: 160204703,
    //     market_cap_change_percentage_24h: 0.54826,
    //     circulating_supply: 55430475754,
    //     total_supply: 99987593568,
    //     max_supply: 100000000000,
    //     ath: 3.4,
    //     ath_change_percentage: -84.40146,
    //     ath_date: "2018-01-07T00:00:00.000Z",
    //     atl: 0.00268621,
    //     atl_change_percentage: 19634.46226,
    //     atl_date: "2014-05-22T00:00:00.000Z",
    //     roi: null,
    //     last_updated: "2024-05-24T04:45:22.591Z",
    //     price_change_percentage_1h_in_currency: 0.015174246356244191,
    //     price_change_percentage_1y_in_currency: 15.826025496036255,
    //     price_change_percentage_24h_in_currency: 0.3253266949752871,
    //     price_change_percentage_30d_in_currency: -3.018331299016001,
    //     price_change_percentage_7d_in_currency: 2.603376765753538,
    //   },
    //   {
    //     id: "dogecoin",
    //     symbol: "doge",
    //     name: "Dogecoin",
    //     image:
    //       "https://assets.coingecko.com/coins/images/5/large/dogecoin.png?1696501409",
    //     current_price: 0.16,
    //     market_cap: 22976131908,
    //     market_cap_rank: 9,
    //     fully_diluted_valuation: 22979263325,
    //     total_volume: 1847143259,
    //     high_24h: 0.16925,
    //     low_24h: 0.153648,
    //     price_change_24h: -0.007478916534913865,
    //     price_change_percentage_24h: -4.49063,
    //     market_cap_change_24h: -1046508407.2786217,
    //     market_cap_change_percentage_24h: -4.35634,
    //     circulating_supply: 144397986383.705,
    //     total_supply: 144417666383.705,
    //     max_supply: null,
    //     ath: 0.731578,
    //     ath_change_percentage: -78.24619,
    //     ath_date: "2021-05-08T05:08:23.458Z",
    //     atl: 0.0000869,
    //     atl_change_percentage: 183029.13131,
    //     atl_date: "2015-05-06T00:00:00.000Z",
    //     roi: null,
    //     last_updated: "2024-05-24T04:46:05.752Z",
    //     price_change_percentage_1h_in_currency: -0.4463248721879912,
    //     price_change_percentage_1y_in_currency: 122.35621393409708,
    //     price_change_percentage_24h_in_currency: -4.490630994936353,
    //     price_change_percentage_30d_in_currency: -2.2271767105538776,
    //     price_change_percentage_7d_in_currency: 5.661016967783135,
    //   },
    //   {
    //     id: "shiba-inu",
    //     symbol: "shib",
    //     name: "Shiba Inu",
    //     image:
    //       "https://assets.coingecko.com/coins/images/11939/large/shiba.png?1696511800",
    //     current_price: 0,
    //     market_cap: 14398699557,
    //     market_cap_rank: 13,
    //     fully_diluted_valuation: 24434668857,
    //     total_volume: 717712176,
    //     high_24h: 0.00002568,
    //     low_24h: 0.00002368,
    //     price_change_24h: -9.71241804133e-7,
    //     price_change_percentage_24h: -3.82023,
    //     market_cap_change_24h: -581456364.4991074,
    //     market_cap_change_percentage_24h: -3.88151,
    //     circulating_supply: 589262969631904.4,
    //     total_supply: 999982357804804,
    //     max_supply: null,
    //     ath: 0.00008616,
    //     ath_change_percentage: -71.6488,
    //     ath_date: "2021-10-28T03:54:55.568Z",
    //     atl: 5.6366e-11,
    //     atl_change_percentage: 43336105.32374,
    //     atl_date: "2020-11-28T11:26:25.838Z",
    //     roi: null,
    //     last_updated: "2024-05-24T04:46:10.710Z",
    //     price_change_percentage_1h_in_currency: -0.033591208950192505,
    //     price_change_percentage_1y_in_currency: 181.07314376561982,
    //     price_change_percentage_24h_in_currency: -3.8202338578438333,
    //     price_change_percentage_30d_in_currency: -10.055473900531098,
    //     price_change_percentage_7d_in_currency: -0.016094986963459252,
    //   },
    //   {
    //     id: "polkadot",
    //     symbol: "dot",
    //     name: "Polkadot",
    //     image:
    //       "https://assets.coingecko.com/coins/images/12171/large/polkadot.png?1696512008",
    //     current_price: 7.27,
    //     market_cap: 9932824464,
    //     market_cap_rank: 17,
    //     fully_diluted_valuation: 10520734096,
    //     total_volume: 350606634,
    //     high_24h: 7.59,
    //     low_24h: 6.95,
    //     price_change_24h: -0.32290619466790815,
    //     price_change_percentage_24h: -4.25545,
    //     market_cap_change_24h: -428061414.99380875,
    //     market_cap_change_percentage_24h: -4.13151,
    //     circulating_supply: 1367648160.91943,
    //     total_supply: 1448597293.82371,
    //     max_supply: null,
    //     ath: 54.98,
    //     ath_change_percentage: -86.79888,
    //     ath_date: "2021-11-04T14:10:09.301Z",
    //     atl: 2.7,
    //     atl_change_percentage: 169.07189,
    //     atl_date: "2020-08-20T05:48:11.359Z",
    //     roi: null,
    //     last_updated: "2024-05-24T04:45:27.521Z",
    //     price_change_percentage_1h_in_currency: -0.22284823303110524,
    //     price_change_percentage_1y_in_currency: 37.32985417912344,
    //     price_change_percentage_24h_in_currency: -4.255447194885201,
    //     price_change_percentage_30d_in_currency: -0.3536068935444917,
    //     price_change_percentage_7d_in_currency: 3.7269590085232056,
    //   },
    //   {
    //     id: "litecoin",
    //     symbol: "ltc",
    //     name: "Litecoin",
    //     image:
    //       "https://assets.coingecko.com/coins/images/2/large/litecoin.png?1696501400",
    //     current_price: 85.94,
    //     market_cap: 6406843629,
    //     market_cap_rank: 22,
    //     fully_diluted_valuation: 7217590453,
    //     total_volume: 651068645,
    //     high_24h: 87.5,
    //     low_24h: 81.88,
    //     price_change_24h: -0.4605762024623914,
    //     price_change_percentage_24h: -0.53305,
    //     market_cap_change_24h: -43626164.83858776,
    //     market_cap_change_percentage_24h: -0.67633,
    //     circulating_supply: 74564339.4834713,
    //     total_supply: 84000000,
    //     max_supply: 84000000,
    //     ath: 410.26,
    //     ath_change_percentage: -79.05847,
    //     ath_date: "2021-05-10T03:13:07.904Z",
    //     atl: 1.15,
    //     atl_change_percentage: 7378.3699,
    //     atl_date: "2015-01-14T00:00:00.000Z",
    //     roi: null,
    //     last_updated: "2024-05-24T04:45:51.025Z",
    //     price_change_percentage_1h_in_currency: 0.14879053130158237,
    //     price_change_percentage_1y_in_currency: -3.658070757060059,
    //     price_change_percentage_24h_in_currency: -0.5330499579600925,
    //     price_change_percentage_30d_in_currency: -0.15998713131800368,
    //     price_change_percentage_7d_in_currency: 4.733561409624428,
    //   },
    //   {
    //     id: "hashflow",
    //     symbol: "hft",
    //     name: "Hashflow",
    //     image:
    //       "https://assets.coingecko.com/coins/images/26136/large/hashflow-icon-cmc.png?1696525224",
    //     current_price: 0.29,
    //     market_cap: 117675818,
    //     market_cap_rank: 431,
    //     fully_diluted_valuation: 292086288,
    //     total_volume: 13057157,
    //     high_24h: 0.309974,
    //     low_24h: 0.280837,
    //     price_change_24h: -0.01639011544969654,
    //     price_change_percentage_24h: -5.31136,
    //     market_cap_change_24h: -6585826.927363038,
    //     market_cap_change_percentage_24h: -5.29997,
    //     circulating_supply: 402880323.2264,
    //     total_supply: 1000000000,
    //     max_supply: 1000000000,
    //     ath: 3.61,
    //     ath_change_percentage: -91.90934,
    //     ath_date: "2022-11-07T13:04:41.540Z",
    //     atl: 0.199986,
    //     atl_change_percentage: 46.10829,
    //     atl_date: "2022-11-07T12:54:58.666Z",
    //     roi: null,
    //     last_updated: "2024-05-24T04:45:49.734Z",
    //     price_change_percentage_1h_in_currency: -0.4479409302210985,
    //     price_change_percentage_1y_in_currency: -33.377487817172494,
    //     price_change_percentage_24h_in_currency: -5.311364306978645,
    //     price_change_percentage_30d_in_currency: -11.477435956194206,
    //     price_change_percentage_7d_in_currency: 0.4178854665201798,
    //   },
    // ];

    const response = await fetch(
      `${process.env.COINGECKO_API_URI}/coins/markets?ids=${tickersList.join(
        ","
      )}&vs_currency=usd&precision=2&price_change_percentage=1h,24h,7d,30d,1y`
    );

    if (!response.ok) {
      throw new NextResponse("Failed to obtain tickers list prices", {
        status: 500,
      });
    }
    const jsonData = await response.json();

    const transformedData = jsonData.reduce((acc, coin) => {
      acc[coin.id] = {
        symbol: coin.symbol,
        image: coin.image,
        name: coin.name,
        price_usd: coin.current_price,
        usd_24h_percent_change: coin.price_change_percentage_24h_in_currency,
        usd_1h_percent_change: coin.price_change_percentage_1h_in_currency,
        usd_30d_percent_change: coin.price_change_percentage_30d_in_currency,
        usd_7d_percent_change: coin.price_change_percentage_7d_in_currency,
        usd_1y_percent_change: coin.price_change_percentage_1y_in_currency,
      };
      return acc;
    }, {});

    console.log("JSON Data: ", jsonData);

    // console.log("Data returned: ", transformedData);

    // bitcoin: { usd: 69996.4, usd_24h_change: 5.491128320065069 },
    // ethereum: { usd: 3403.56, usd_24h_change: 10.62600124711219 },
    // ripple: { usd: 0.53, usd_24h_change: 4.8177733104448395 },
    // solana: { usd: 183.04, usd_24h_change: 7.912279764254268 }

    return new NextResponse(JSON.stringify(transformedData), { status: 200 });
  } catch (error) {
    console.log("[CRYPTO SIMPLE POST]", error);
    return new NextResponse(
      "Internal server while getting tickers list price data",
      {
        status: 500,
      }
    );
  }
}
